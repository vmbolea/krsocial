data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
muni.data <-sf::st_drop_geometry(muni.shp)
muni.data <- muni.data[,c("objectid",   "c_muni_ine", "d_muni_ine", "c_comarca",  "d_comarca", "sup_of_km2")]
for( i in 1:length(links)){
#i<-217
i.path <- grep(pattern = "municipal",
x = xml_attrs(links[[i]]),
value = T)
if(length(i.path) > 0){
print(i)
i.path <- gsub(pattern = "\\+",
replacement = "_",
x = i.path)
year.i <- as.numeric(gsub( pattern = ".*ipal_",
replacement = "",
x = gsub( pattern = ".x.*$",
replacement = "",
x = i.path)))
if(!is.na(year.i) & year.i > 2014){
temp_file <- tempfile()
download.file(paste0(url.dl,i.path), temp_file, mode = "wb")
for(j in c("Bovino","Ovino-Caprino","Porcino")){
print(j)
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i$code <- ifelse( test = data.i$code %in% c("24420", "24421"),
yes = data.i$code -200,
no =  data.i$code )
data.i <- data.i[!data.i$code %in% "22",]
print(paste0("diff after ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
muni.data <- merge(muni.data, data.i,  by.x = "c_muni_ine" , by.y = "code", all.x = TRUE)
print(nrow(muni.data))
}
}
}
}
View(muni.data)
i<-217
i<-216
i.path <- grep(pattern = "municipal",
x = xml_attrs(links[[i]]),
value = T)
print(i)
i.path <- gsub(pattern = "\\+",
replacement = "_",
x = i.path)
year.i <- as.numeric(gsub( pattern = ".*ipal_",
replacement = "",
x = gsub( pattern = ".x.*$",
replacement = "",
x = i.path)))
temp_file <- tempfile()
download.file(paste0(url.dl,i.path), temp_file, mode = "wb")
print(j)
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i$code <- ifelse( test = data.i$code %in% c("24420", "24421"),
yes = data.i$code -200,
no =  data.i$code )
data.i <- data.i[!data.i$code %in% "22",]
print(paste0("diff after ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
View(data.i)
length(unique(data.i$code))
length(unique(muni.data$c_muni_ine))
all(unique(data.i$code) %in% unique(muni.data$c_muni_ine))
muni.data2 <- merge(muni.data, data.i,  by.x = "c_muni_ine" , by.y = "code", all.x = TRUE)
j <- "Bovino"
print(j)
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i$code <- ifelse( test = data.i$code %in% c("24420", "24421"),
yes = data.i$code -200,
no =  data.i$code )
data.i <- data.i[!data.i$code %in% "22",]
print(paste0("diff after ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
all(unique(data.i$code) %in% unique(muni.data$c_muni_ine))
muni.data2 <- merge(muni.data, data.i,  by.x = "c_muni_ine" , by.y = "code", all.x = TRUE)
View(muni.data2)
muni.data <- merge(x = muni.data,
y = pop.data,
by.x = "objectid",
by.y)
all(unique(data.i$code) %in% unique(muni.data$c_muni_ine))
View(muni.data2)
for(z in unique(muni.data$c_muni_ine)){
muni.data.z <- muni.data[muni.data$c_muni_ine == z,]
muni.data.2.z <- muni.data.2[muni.data.2$c_muni_ine == z,]
message("df ",z, " with ",nrow(muni.data.z))
message("df ",z, " with ",nrow(muni.data.2.z))
}
for(z in unique(muni.data$c_muni_ine)){
muni.data.z <- muni.data[muni.data$c_muni_ine == z,]
muni.data2.z <- muni.data2[muni.data2$c_muni_ine == z,]
message("df ",z, " with ",nrow(muni.data.z))
message("df ",z, " with ",nrow(muni.data2.z))
}
for(z in unique(muni.data$c_muni_ine)){
muni.data.z <- muni.data[muni.data$c_muni_ine == z,]
muni.data2.z <- muni.data2[muni.data2$c_muni_ine == z,]
message("df ",z, " with ",nrow(muni.data.z) - nrow(muni.data2.z) )
# message("df ",z, " with ",nrow(muni.data2.z))
}
View(data.i)
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
data.i <- readxl::read_excel(temp_file,sheet = j)
View(data.i)
?grouping
?agrregate
?aggregate
?aggregate
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i$code <- ifelse( test = data.i$code %in% c("24420", "24421"),
yes = data.i$code -200,
no =  data.i$code )
data.i <- data.i[!data.i$code %in% "22",]
print(paste0("diff after ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i <- data.i[!duplicated(data.i$code), ]
View(data.i)
muni.data <-sf::st_drop_geometry(muni.shp)
muni.data <- muni.data[,c("objectid",   "c_muni_ine", "d_muni_ine", "c_comarca",  "d_comarca", "sup_of_km2")]
for( i in 1:length(links)){
#i<-216
i.path <- grep(pattern = "municipal",
x = xml_attrs(links[[i]]),
value = T)
if(length(i.path) > 0){
print(i)
i.path <- gsub(pattern = "\\+",
replacement = "_",
x = i.path)
year.i <- as.numeric(gsub( pattern = ".*ipal_",
replacement = "",
x = gsub( pattern = ".x.*$",
replacement = "",
x = i.path)))
if(!is.na(year.i)){
temp_file <- tempfile()
download.file(paste0(url.dl,i.path), temp_file, mode = "wb")
for(j in c("Bovino","Ovino-Caprino","Porcino")){
print(j)
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i$code <- ifelse( test = data.i$code %in% c("24420", "24421"),
yes = data.i$code -200,
no =  data.i$code )
data.i <- data.i[!data.i$code %in% "22",]
print(paste0("diff after ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i <- data.i[!duplicated(data.i$code), ]
muni.data2 <- merge(muni.data, data.i,  by.x = "c_muni_ine" , by.y = "code", all.x = TRUE)
print(nrow(muni.data))
}
}
}
}
muni.data <-sf::st_drop_geometry(muni.shp)
muni.data <- muni.data[,c("objectid",   "c_muni_ine", "d_muni_ine", "c_comarca",  "d_comarca", "sup_of_km2")]
for( i in 1:length(links)){
#i<-216
i.path <- grep(pattern = "municipal",
x = xml_attrs(links[[i]]),
value = T)
if(length(i.path) > 0){
print(i)
i.path <- gsub(pattern = "\\+",
replacement = "_",
x = i.path)
year.i <- as.numeric(gsub( pattern = ".*ipal_",
replacement = "",
x = gsub( pattern = ".x.*$",
replacement = "",
x = i.path)))
if(!is.na(year.i)){
temp_file <- tempfile()
download.file(paste0(url.dl,i.path), temp_file, mode = "wb")
for(j in c("Bovino","Ovino-Caprino","Porcino")){
print(j)
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i$code <- ifelse( test = data.i$code %in% c("24420", "24421"),
yes = data.i$code -200,
no =  data.i$code )
data.i <- data.i[!data.i$code %in% "22",]
print(paste0("diff after ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i <- data.i[!duplicated(data.i$code), ]
muni.data <- merge(muni.data, data.i,  by.x = "c_muni_ine" , by.y = "code", all.x = TRUE)
print(nrow(muni.data))
}
}
}
}
View(muni.data)
View(pop.data)
paste0("h_",2021:2013)
pop.data <- read.csv(pop.file, sep = ",")
pop.data <- pop.data[41:nrow(pop.data),]
pop.codes <- sapply(strsplit(as.character(pop.data$Lugar.de.residencia), "[0-9] "), "[", 1)
pop.data <- pop.data[, endsWith(names(pop.data), "os")]
pop.names <- paste0("h_", gsub(pattern = ".*enero.",
replacement = "",
x = gsub( pattern = ".Ambos.*$",
replacement = "",
x = names(pop.data))))
names(pop.data) <- pop.names
pop.data <- pop.data[,c(paste0("h_",2021:2013))]
View(pop.data)
pop.data$h_2022 <- pop.data$h_2021
pop.data <- cbind( ine = pop.codes, pop.data)
View(pop.data)
muni.data <- merge(x = muni.data,
y = pop.data,
by.x = "objectid",
by.y = "ine")
muni.data <-sf::st_drop_geometry(muni.shp)
muni.data <- muni.data[,c("objectid",   "c_muni_ine", "d_muni_ine", "c_comarca",  "d_comarca", "sup_of_km2")]
for( i in 1:length(links)){
#i<-216
i.path <- grep(pattern = "municipal",
x = xml_attrs(links[[i]]),
value = T)
if(length(i.path) > 0){
print(i)
i.path <- gsub(pattern = "\\+",
replacement = "_",
x = i.path)
year.i <- as.numeric(gsub( pattern = ".*ipal_",
replacement = "",
x = gsub( pattern = ".x.*$",
replacement = "",
x = i.path)))
if(!is.na(year.i)){
temp_file <- tempfile()
download.file(paste0(url.dl,i.path), temp_file, mode = "wb")
for(j in c("Bovino","Ovino-Caprino","Porcino")){
print(j)
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i$code <- ifelse( test = data.i$code %in% c("24420", "24421"),
yes = data.i$code -200,
no =  data.i$code )
data.i <- data.i[!data.i$code %in% "22",]
print(paste0("diff after ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i <- data.i[!duplicated(data.i$code), ]
muni.data <- merge(muni.data, data.i,  by.x = "c_muni_ine" , by.y = "code", all.x = TRUE)
print(nrow(muni.data))
}
}
}
}
View(muni.data)
muni.data <-sf::st_drop_geometry(muni.shp)
muni.data <- muni.data[,c("objectid",   "c_muni_ine", "d_muni_ine", "c_comarca",  "d_comarca", "sup_of_km2")]
for( i in 1:length(links)){
#i<-216
i.path <- grep(pattern = "municipal",
x = xml_attrs(links[[i]]),
value = T)
if(length(i.path) > 0){
print(i)
i.path <- gsub(pattern = "\\+",
replacement = "_",
x = i.path)
year.i <- as.numeric(gsub( pattern = ".*ipal_",
replacement = "",
x = gsub( pattern = ".x.*$",
replacement = "",
x = i.path)))
if(!is.na(year.i)){
temp_file <- tempfile()
download.file(paste0(url.dl,i.path), temp_file, mode = "wb")
for(j in c("Bovino","Ovino-Caprino","Porcino")){
print(j)
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i$code <- ifelse( test = data.i$code %in% c("24420", "24421"),
yes = data.i$code + 19800,
no =  data.i$code )
data.i <- data.i[!data.i$code %in% "22",]
print(paste0("diff after ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i <- data.i[!duplicated(data.i$code), ]
muni.data <- merge(muni.data, data.i,  by.x = "c_muni_ine" , by.y = "code", all.x = TRUE)
print(nrow(muni.data))
}
}
}
}
source("D:/Github/krsocial/R/processing.R")
muni.data <- merge(x = muni.data,
y = pop.data,
by.x = "objectid",
by.y = "ine",
all.x = TRUE)
View(muni.data)
View(pop.data)
muni.data <-sf::st_drop_geometry(muni.shp)
muni.data <- muni.data[,c("objectid",   "c_muni_ine", "d_muni_ine", "c_comarca",  "d_comarca", "sup_of_km2")]
if(!dir.exists("data")){
dir.create(path = "data" )
}
output.path <- "data"
output.name <- "ganaderia_municipal"
x <- c()
for( i in 1:length(links)){
#i<-216
i.path <- grep(pattern = "municipal",
x = xml_attrs(links[[i]]),
value = T)
if(length(i.path) > 0){
print(i)
i.path <- gsub(pattern = "\\+",
replacement = "_",
x = i.path)
year.i <- as.numeric(gsub( pattern = ".*ipal_",
replacement = "",
x = gsub( pattern = ".x.*$",
replacement = "",
x = i.path)))
if(!is.na(year.i)){
temp_file <- tempfile()
download.file(paste0(url.dl,i.path), temp_file, mode = "wb")
for(j in c("Bovino","Ovino-Caprino","Porcino")){
print(j)
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i$code <- ifelse( test = data.i$code %in% c("24420", "24421"),
yes = data.i$code + 19800,
no =  data.i$code )
data.i <- data.i[!data.i$code %in% "22",]
print(paste0("diff after ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i <- data.i[!duplicated(data.i$code), ]
muni.data <- merge(muni.data, data.i,  by.x = "c_muni_ine" , by.y = "code", all.x = TRUE)
print(nrow(muni.data))
}
}
}
}
View(muni.data)
View(pop.data)
pop.data <- read.csv(pop.file, sep = ",")
pop.data <- pop.data[41:nrow(pop.data),]
View(pop.data)
pop.codes <- sapply(strsplit(as.character(pop.data$Lugar.de.residencia), "[0-9] "), "[", 1)
View(pop.data)
strsplit(as.character(pop.data$Lugar.de.residencia)
strsplit(as.character(pop.data$Lugar.de.residencia), "[0-9] ")
View(pop.data)
pop.codes <- sapply(strsplit(as.character(pop.data$Lugar.de.residencia), " "), "[", 1)
pop.data <- pop.data[, endsWith(names(pop.data), "os")]
pop.names <- paste0("h_", gsub(pattern = ".*enero.",
replacement = "",
x = gsub( pattern = ".Ambos.*$",
replacement = "",
x = names(pop.data))))
names(pop.data) <- pop.names
pop.data <- pop.data[,c(paste0("h_",2021:2013))]
pop.data$h_2022 <- pop.data$h_2021
pop.data <- cbind( ine = pop.codes, pop.data)
muni.data2 <- merge(x = muni.data,
y = pop.data,
by.x = "objectid",
by.y = "ine",
all.x = TRUE)
View(muni.data2)
muni.data2 <- merge(x = muni.data,
y = pop.data,
by.x = "c_muni_ine",
by.y = "ine",
all.x = TRUE)
View(muni.data2)
muni.data <-sf::st_drop_geometry(muni.shp)
muni.data <- muni.data[,c("c_muni_ine", "d_muni_ine", "c_comarca",  "d_comarca", "sup_of_km2")]
for( i in 1:length(links)){
#i<-216
i.path <- grep(pattern = "municipal",
x = xml_attrs(links[[i]]),
value = T)
if(length(i.path) > 0){
print(i)
i.path <- gsub(pattern = "\\+",
replacement = "_",
x = i.path)
year.i <- as.numeric(gsub( pattern = ".*ipal_",
replacement = "",
x = gsub( pattern = ".x.*$",
replacement = "",
x = i.path)))
if(!is.na(year.i)){
temp_file <- tempfile()
download.file(paste0(url.dl,i.path), temp_file, mode = "wb")
for(j in c("Bovino","Ovino-Caprino","Porcino")){
print(j)
data.i <- readxl::read_excel(temp_file,sheet = j)
new.name <- tolower(substr(j, 0, 1))
data.i <- data.i[,c(2,ncol(data.i))]
names(data.i) <- c("code",paste0(new.name,"_",year.i))
print(nrow(data.i))
print(paste0("diff ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i$code <- ifelse( test = data.i$code %in% c("24420", "24421"),
yes = data.i$code + 19800,
no =  data.i$code )
data.i <- data.i[!data.i$code %in% "22",]
print(paste0("diff after ", data.i$code[!data.i$code %in% muni.data$c_muni_ine]))
data.i <- data.i[!duplicated(data.i$code), ]
muni.data <- merge(muni.data, data.i,  by.x = "c_muni_ine" , by.y = "code", all.x = TRUE)
print(nrow(muni.data))
}
}
}
}
muni.data <- merge(x = muni.data,
y = pop.data,
by.x = "c_muni_ine",
by.y = "ine",
all.x = TRUE)
muni.geo <- muni.shp[, "c_muni_ine"]
muni.geo <-rbind(muni.geo, muni.data)
muni.geo <-merge(muni.geo, muni.data)
View(muni.geo)
View(muni.geo[[46]][[1]])
muni.geo[[46]][[1]][[1]][[1]]
View(muni.data)
View(muni.geo)
View(muni.geo[[46]][[2]])
muni.geo[[46]][[2]][[1]][[1]]
muni.geo[[46]][[2]][[1]][[1]]
dplyr::all_equal(muni.geo[[46]][[2]][[1]][[1]], muni.geo[[46]][[1]][[1]][[1]])
dplyr::all_equal(muni.geo[[46]][[2]][[1]][[1]], muni.geo[[46]][[3]][[1]][[1]])
dplyr::all_equal(muni.geo[[46]][[2]][[1]][[1]], muni.geo[[47]][[2]][[1]][[1]])
dplyr::all_equal(muni.geo[[46]][[2]][[1]][[1]], muni.geo[[46]][[4]][[1]][[1]])
dplyr::all_equal(muni.geo[[46]][[2]][[1]][[1]], muni.geo[[46]][[5]][[1]][[1]])
x <- muni.geo[[46]][[1]][[1]][[1]]
View(x)
y <- muni.geo[[46]][[2]][[1]][[1]]
setdiff(x,y)
y <- muni.geo[[46]][[4]][[1]][[1]]
View(muni.geo)
View(muni.geo[[46]][[10]])
y <- muni.geo[[46]][[10]][[1]][[1]]
setdiff(x,y)
muni.geo2 <- muni.geo[!duplicated(muni.geo), ]
View(muni.geo2)
muni.geo2[duplicated(muni.geo2$c_muni_ine), ]
View(muni.geo2)
View(muni.geo2[[46]][[217]])
x <- muni.geo2[[46]][[217]][[1]][[1]]
y <- muni.geo2[[46]][[218]][[1]][[1]]
View(muni.shp)
j <-muni.geo2[duplicated(muni.geo2$c_muni_ine), ]
View(j)
?st_write
sf::st_write(muni.geo2, paste0("data/g_data.shp"))
muni.geo2
?replace
muni.geo2[is.na(muni.geo2)] <- 0
sf::st_write(muni.geo2, paste0("data/g_data.shp"))
?st_write
sf::st_write(muni.geo2, paste0("data/g_data.shp"),layer_options = c("OVERWRITE=yes"))
sf::st_write(muni.geo2, paste0("data/g_data.shp"),layer_options = "OVERWRITE=true")
View(muni.geo2)
sf::st_write(muni.geo2, paste0("data/g_data.shp"),layer_options = "OVERWRITE=true")
sf::st_write(muni.geo2, paste0("data/g_data.shp"))
library("rgdal")
data(muni.geo2)
class(muni.geo2)
install.packages("geojsonsf")
library(geojsonsf)
sf_geojson(muni.geo2, atomise = T)
sf::st_write(muni.geo2, paste0("data/g_data.geojson"))
str(muni.geo2)
View(muni.geo)
View(muni.data)
